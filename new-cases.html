<html>
  <head>
    <script>
      let parseDate = str => {
        var dmy = str.split("/");
        return new Date(dmy[2], dmy[1] - 1, dmy[0]);
      };

      let datediff = (first, second) => {
        // Take the difference between the dates and divide by milliseconds per day.
        // Round to nearest whole number to deal with DST.
        return Math.round((second - first) / (1000 * 60 * 60 * 24));
      };

      fetch(
        "https://interactive.guim.co.uk/docsdata/1q5gdePANXci8enuiS4oHUJxcxC13d6bjMRSicakychE.json"
      )
        .then(res => {
          if (res.ok) {
            return res.json();
          } else {
            body.innerText =
              "Something went wrong, please report an issue here: " +
              res.status +
              res.statusText;
          }
        })
        .then(json => {
          let data = json.sheets.updates.reduce((acc, item) => {
            let state = item["State"];
            if (!acc[state]) {
              acc[state] = [];
            }

            if (item["Cumulative case count"] !== "") {
              acc[state].push(item);
            }

            return acc;
          }, {});

          let body = document.getElementById("body");

          let getDay1With0NewCases = covidEvents => {
            let today = covidEvents[covidEvents.length - 1];
            return covidEvents.find(
              yesterday =>
                today["Cumulative case count"] -
                  yesterday["Cumulative case count"] ==
                  0 && today["Date"] !== yesterday["Date"]
            );
          };

          let daysSinceView = (covidEvents, region, aggregate) => {
            {
              // new Date("dateString") is browser-dependent and discouraged, so we'll write
              // a simple parse function for AU date format (which does no error checking)

              let today = covidEvents[covidEvents.length - 1];
              let day1With0NewCases = getDay1With0NewCases(covidEvents);

              let p1 = document.createElement("p");
              let p2 = document.createElement("p");
              let p3 = document.createElement("p");

              if (day1With0NewCases) {
                let daysSinceLast = datediff(
                  parseDate(day1With0NewCases["Date"]),
                  parseDate(today["Date"])
                );

                p1.innerText = "It has been";
                p2.innerText =
                  daysSinceLast + (daysSinceLast == 1 ? " day" : " days");
                p3.innerText = "since " + region + "'s latest covid-19 case";
              } else {
                let yesterday = covidEvents[covidEvents.length - 2];
                let casesSinceYesterday =
                  today["Cumulative case count"] -
                  yesterday["Cumulative case count"];

                p1.innerText = region + " has had";
                p2.innerText =
                  (aggregate ? "â‰¤ " : "") +
                  casesSinceYesterday +
                  (casesSinceYesterday == 1
                    ? " new case of covid-19"
                    : " new cases of covid-19");
                p3.innerText =
                  "between " + yesterday["Date"] + " and " + today["Date"];
              }

              body.appendChild(p1);
              body.appendChild(p2);
              body.appendChild(p3);
            }
          };

          let renderDaysSince = (data, state) => {
            body.innerHTML = "";

            navView(data);
            daysSinceView(data[state], state);
          };

          let button = (label, onClick) => {
            let el = document.createElement("button");

            el.innerText = label;
            el.onclick = onClick;

            body.append(el);
          };

          let navView = data => {
            button("Australia", renderPage);
            Object.keys(data).forEach(state => {
              button(state, () => renderDaysSince(data, state));
            });
          };

          let renderPage = () => {
            body.innerHTML = "";

            let auDates = Object.keys(data).reduce((acc, state) => {
              data[state].sort((a, b) => datediff(a["Date"], b["Date"]));

              let yesterday = data[state][data[state].length - 2]["Date"];
              let today = data[state][data[state].length - 1]["Date"];

              if (getDay1With0NewCases(data[state])) {
                return acc;
              }

              if (acc.length == 0) {
                acc[0] = yesterday;
                acc[1] = today;
              } else {
                if (parseDate(yesterday) < parseDate(acc[0])) {
                  acc[0] = yesterday;
                }
                if (parseDate(today) < parseDate(acc[1])) {
                  acc[1] = today;
                }
              }
              return acc;
            }, []);

            let auData = [];
            Object.keys(data).forEach((state, idx) => {
              if (idx == 0) {
                auData[0] = { "Cumulative case count": 0 };
                auData[1] = { "Cumulative case count": 0 };
              }

              let fstDate = data[state].reduce((acc, item, idx) => {
                if (!acc) {
                  if (parseDate(item["Date"]) == parseDate(auDates[0])) {
                    return item;
                  } else if (parseDate(item["Date"]) > parseDate(auDates[0])) {
                    return data[state][idx - 1];
                  }
                }
                return acc;
              }, null);

              if (fstDate) {
                auData[0]["Cumulative case count"] += parseInt(
                  fstDate["Cumulative case count"]
                );
              } else {
                auData[0]["Cumulative case count"] += parseInt(
                  data[state][data[state].length - 2]["Cumulative case count"]
                );
              }
              auData[1]["Cumulative case count"] += parseInt(
                data[state][data[state].length - 1]["Cumulative case count"]
              );
            });
            navView(data);

            auData[0]["Date"] = auDates[0];
            auData[1]["Date"] = auDates[1];

            daysSinceView(auData, "Australia", true);
          };

          renderPage();
          console.log(data);
        });
    </script>
  </head>
  <body id="body"></body>
</html>
